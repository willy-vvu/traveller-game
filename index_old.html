<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Traveller</title>
    <link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet">
    <style>
      html,body,.full-image{
        position:absolute;
        left:0;right:0;top:0;bottom:0;
      }
      body{
        background-color:black;
        margin:0;
        font-family:Rubik,sans-serif;
      }
      .text-bottom{
        position:absolute;
        bottom:40px;
        left:0;
        right:0;
        min-height:100px;
        margin-left:auto;
        margin-right:auto;
        max-width:650px;
        padding:20px;
        font-size:14pt;
        background-color: rgba(0,0,0,0.2);
        box-shadow:0 0 18px 10px rgba(0,0,0,0.2);
        color:white;
        line-height:1.4em;
        letter-spacing:0.005em;
      }
      .full-image{
        background-size:cover;
        background-position:50%;
        background-repeat:no-repeat;
      }
      /*#devpanel{
        position:absolute;
        bottom:0;
        left:0;
        top:0;
        width:50%;
        background-color:rgba(20,20,20,0.7);
        z-index:99;
      }*/
    </style>
  </head>
  <body>
    <div class="full-image" id="scene"></div>
    <div class="full-image" id="character"></div>
    <div class="text-bottom" id="text"></div>
    <div class="menu-middle" id="menu"></div>
    <!--<div id="devpanel"></div>-->
    </div>
    <script>
      scriptText = "";
      scriptLines = [];
      imageDefs = {};
      characterDefs = {};
      state = {
        variables:{},
        background:"",
        foreground:"",
        text:"",
        options:[0]
      };
      sceneElem = document.getElementById("scene");
      characterElem = document.getElementById("character");
      textElem = document.getElementById("text");
      function scriptLoaded(response){
        scriptText = response.target.response;
        scriptLines = scriptText.replace(/\s*\n/g,"\n").split("\n");
        loadDefines();
        loadState();
        showState();
        // go();
      }

      stopAtStart = false;
      function loadDefines(){
        stopAtStart = true;
        go(0);
      }

      function loadState(){
        state=localStorage.state?JSON.parse(localStorage.state):state;
        showState();
      }
      function showState(){
        localStorage.state = JSON.stringify(state);
        if(state.background !== undefined && imageDefs[state.background] != sceneElem.style.backgroundImage){
          sceneElem.style.backgroundImage = state.background&&"url('images/"+imageDefs[state.background]+"')";
        }
        if(state.foreground !== undefined && imageDefs[state.foreground] != characterElem.style.backgroundImage){
          characterElem.style.backgroundImage = state.foreground&&"url('images/"+imageDefs[state.foreground]+"')";
        }

        if(state.text === undefined || state.text == ""){
          textElem.style.opacity = 0;
        }
        if(state.text !== undefined && state.text != textElem.innerHTML){
          textElem.style.opacity = 1;
          textElem.innerHTML = state.text;
        }
      }
      function go(line){
        var currentLine = scriptLines[line].trimLeft();
        var splitLine = currentLine.split(" ");
        // console.log(currentLine);
        if(currentLine.startsWith("#")){
          go(line+1);
        }
        else if(currentLine.startsWith("image")){
          //Image declaration
          var matches = /image (.*\S) *= *"(.*\S)"/.exec(currentLine);
          var image = matches[1], url = matches[2];
          // console.log(image,url);
          imageDefs[image] = url;
          go(line+1);
        }
        else if(currentLine.startsWith("define")){
          var matches = /define (\S+) *= *Character\("(\S+)"\)/.exec(currentLine);
          var shorthand = matches[1], name = matches[2];
          characterDefs[shorthand] = name;
          // console.log(matches)
          //Character Definition
          go(line+1);
        }
        else if(currentLine.startsWith("label")){
          //Label
          if(stopAtStart && splitLine[1] == "start:"){
            stopAtStart = false;
            return;
          }
          go(line+1);
        }
        else if(currentLine.startsWith("scene")){
          //Show Scene
          var image = splitLine.slice(1).join(" ");
          console.log("%Scene:"+"%c "+imageDefs[image], "color:cyan", "color:inherit");
          state.background = image;
          state.text = "";
          state.foreground = "";
          showState();
          go(line+1);

        }
        else if(currentLine.startsWith("show")){
          //Show character
          var image = splitLine.slice(1).join(" ");
          console.log("%cShowing:"+"%c "+imageDefs[image], "color:cyan", "color:inherit");
          state.foreground = image;
          showState();
          go(line+1);

        }
        else if(currentLine.startsWith("with")){
          //Scene Modifier
          go(line+1);

        }
        else if(currentLine.startsWith("\"")){
          //Full String line
          var lineText = currentLine.slice(1,-1);
          state.text = lineText;
          showState();
          console.log(lineText);
          state.options = [line + 1];
        }
        else if(splitLine[0] in characterDefs){
          // Character says line
          var fromCharacter = characterDefs[splitLine[0]];
          var lineText = splitLine.slice(1).join(" ").slice(1,-1);
          console.log("%c" + fromCharacter + ":"+"%c " + lineText, "color:orange", "color:inherit")
          state.text = fromCharacter + ": " + lineText;
          showState();
          state.options = [line + 1];
        }
        else if(currentLine.startsWith("pause")){
          //Pause (seconds)
          var matches = /pause *\( *(\S+) *\)/.exec(currentLine);
          var pauseTime = parseFloat(matches[1]);
          setTimeout(function(){
            go(line+1);
          }, pauseTime*1000);
        }
        else{
          console.error("Unknown line: " + currentLine);
        }
      }

      function hasParent(index){
        return indentOf(index) > 0;
      }
      function getParent(index){
        if(!hasParent(index)){
          return index;
        }
        var currentIndent = indentOf(index);
        while(inRange(index - 1)){
          if(indentOf(index - 1) < currentIndent){
            return index - 1;
          }
          index--;
        }
        return index;
      }
      function getNextLEIndent(index){
        var currentIndent = indentOf(index);
        while(inRange(index + 1)){
          if(indentOf(index + 1) <= currentIndent){
            return index + 1;
          }
          index++;
        }
        return index;
      }
      function inRange(index){
        return index >=0 && index < scriptLines.length;
      }
      function indentOf(index){
        return scriptLines[index].length - scriptLines[index].trimLeft().length;
      }

      function advance(){
        if(state.options.length != 1){
          return;
        }
        go(state.options[0]);
      }
      window.onkeydown = function(event){
        // console.log(event);
        if(
         !event.shiftKey &&
         !event.ctrlKey &&
         !event.altKey &&
         !event.metaKey &&
         event.keyCode == 39 || // ->
         event.keyCode == 74 || // J
         event.keyCode == 78 || // N
         event.keyCode == 32    // Space
         ){
           advance();
        }
      }
      document.body.onmousedown = function(){
        advance();
      }
      // document.body.ontouchstart = function(){
      //   advance();
      // }

      var xhr=new XMLHttpRequest();
      xhr.addEventListener("load", scriptLoaded);
      xhr.open("GET","script.rpy");
      xhr.send();
    </script>
  </body>
</html>